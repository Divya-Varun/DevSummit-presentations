
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>4 - Popup content with a function</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">

  <style>
    html,
    body,
    #sceneViewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    .esri-popup.esri-widget {
      max-height: 100%;
    }

    .esri-view-width-xlarge .esri-popup__main-container {
      width: 540px;
    }

    .esri-view-height-less-than-medium .esri-popup__main-container {
      max-height: 500px;
    }

  </style>

  <script src="https://js.arcgis.com/4.6/"></script>
  <script>
    require([
      "esri/layers/FeatureLayer",
      "esri/Map",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/core/watchUtils",
      "dojo/dom",
      "dojo/on",
      "dojo/dom-construct",
      "dojo/domReady!"
    ], function(
      FeatureLayer,
      Map,
      MapView,
      SceneView,
      watchUtils,
      dom,
      on,
      domConstruct
    ) {

      var view;
      var map = new Map({
        basemap: "satellite",
        ground: "world-elevation"
      });
      var popupMap = new Map({
        basemap: "streets"
      });

      var sceneView = new SceneView({
        container: "sceneViewDiv",
        map: map,
        scale: 50000000,
        center: [-101.17, 21.78]
      });

      sceneView.on("click", function(event) {
        // you must overwrite default click-for-popup
        // behavior to display your own popup
        event.stopPropagation();
        sceneView.popup.actions = [];

        var lat = Math.round(event.mapPoint.latitude * 1000) / 1000;
        var lon = Math.round(event.mapPoint.longitude * 1000) / 1000;
        sceneView.popup.open({

          // Set the popup's title to the coordinates of the location
          title: "Map view coordinates: [" + lon + ", " + lat + "]",

          location: event.mapPoint, // Set the location of the popup to the clicked location
          content: setContentInfo(event.mapPoint,
            sceneView.zoom,
            popupMap,
            dojo.byId("mapViewDiv"))
        });
      });

      function setContentInfo(point, zoomLevel, popupMap, mapDiv) {
        if (view === undefined) {
          view = new MapView({
            container: mapDiv,
            map: popupMap,
            zoom: Math.round(zoomLevel)
          });
        }

        // Watch view's stationary property for becoming true.
        watchUtils.whenTrue(view, "ready", function() {
          //listen for zoom change
          view.goTo({
            target: point,
            zoom: view.zoom
          });
        });

        // view.ui.components = ["attribution"];
        return view.container;
      }
    });

  </script>
</head>

<body>
  <div id="sceneViewDiv"></div>
  <div id="mapViewDiv" style="width:500px; height:400px; border: 1px solid #A8A8A8;"></div>

</body>

</html>